#!/usr/bin/perl -w

use freeradius;
use CGI qw(:standard escapeHTML);

$url = "$server/radadm/baja.html";
$http_referer = $ENV{'HTTP_REFERER'};

print header();
&head_html("", "Radius - Administraci&oacute;n de Usuarios - Baja", "#ffffff");

if ($http_referer =~ m/$url/)
{
	my $wwwuser = param('wwwuser');
	my $wwwpass = param('wwwpass');
	my $eliminar = param('eliminar');
	my $nivel = "";

	if (!(&chequeo_password($wwwuser, $wwwpass)))
	{
		&return_error_mysql ("Error en el proceso", "Usuario o password incorrecta", "")
	}

	$nivel = &obtener_nivel($wwwuser);
	if ($nivel eq "Tareas de Consulta")
	{
		&return_error_mysql ("Error en el proceso", "No tiene permisos para acceder a esta opci&oacute;n del men&uacute;", "")
	}

	$dbh = Mysql->connect($host, $database, $dbuser, $dbpass);

	$sql_statement = "SELECT personaldata.UserName, personaldata.Nombre, personaldata.Sexo, personaldata.Documento, personaldata.Direccion, personaldata.Localidad, personaldata.CodigoPostal, personaldata.Telefono, personaldata.Tipo_IVA, personaldata.Cuit, personaldata.Estado, personaldata.E_mails, planes.Nombre, personaldata.PersonalDataID, grupos.Nombre, agentes.Nombre FROM personaldata LEFT JOIN planes ON (personaldata.Plan_ID=planes.ID) LEFT JOIN grupos ON (personaldata.Grupo_ID = grupos.ID) LEFT JOIN agentes ON (personaldata.Agente_ID = agentes.ID) WHERE personaldata.PersonalDataID = ".$eliminar;


	$sth = $dbh->query($sql_statement)
	or die &return_error_mysql ("Error en el proceso", "Hubo un error en la consulta a la Base de Datos.<BR>Consulte al Administrador de la misma", $dbh->errmsg());
		
	if ($sth->numrows == 0)
	{
		&return_error_mysql ("Error en el proceso", "No se encontraron registros que respondan al patr&oacute;n de b&uacute;squeda", $dbh->errmsg());
	}
	elsif ($sth->numrows == 1)
	{
		@arr = $sth->fetchrow;
		($apellido, $nombre) = split /, /, $arr[1];
		$password = &obtener_password ($arr[0]);

		print <<body_baja;
  <FORM ACTION="baja-final.html" METHOD="post\">
   <INPUT TYPE="hidden" NAME="wwwuser" VALUE="$wwwuser">
   <INPUT TYPE="hidden" NAME="wwwpass" VALUE="$wwwpass">
   <INPUT TYPE="hidden" NAME="eliminar" VALUE="$eliminar">
   <TABLE COOL BORDER="1" CELLPADDING="0" CELLSPACING="0" ALIGN="center">
    <TR>
     <TD ALIGN="left" COLSPAN="2">
      <B>
       <FONT FACE="Arial,Helvetica,Geneva,Swiss,SunSans-Regular" COLOR="red" SIZE="4">
        &iquest; Esta seguro que desea eliminar los registros del usuario $arr[0] ?
        <BR>
       </FONT>
      </B>
     </TD>
    </TR>

    <TR>
     <TD ALIGN="left" COLSPAN="2">
      <B>
       <FONT FACE="Arial,Helvetica,Geneva,Swiss,SunSans-Regular" COLOR="black" SIZE="4">
        Datos Personales
       </FONT>
      </B>
     </TD>
    </TR>

    <TR>
     <TD ALIGN="left">
      <B>
       <FONT FACE="Arial,Helvetica,Geneva,Swiss,SunSans-Regular" COLOR="black">
        Apellido:
       </FONT>
      </B>
     </TD>
     <TD ALIGN="left">
      <FONT FACE="Arial,Helvetica,Geneva,Swiss,SunSans-Regular" COLOR="black">
       $apellido
      </FONT>
     </TD>
    </TR>

    <TR>
     <TD ALIGN="left">
      <B>
       <FONT FACE="Arial,Helvetica,Geneva,Swiss,SunSans-Regular" COLOR="black">
        Nombre:
       </FONT>
      </B>
     </TD>
     <TD ALIGN="left">
      <FONT FACE="Arial,Helvetica,Geneva,Swiss,SunSans-Regular" COLOR="black">
       $nombre
      </FONT>
     </TD>
    </TR>

    <TR>
     <TD ALIGN="left">
      <B>
       <FONT FACE="Arial,Helvetica,Geneva,Swiss,SunSans-Regular" COLOR="black">
        Nro. Cliente:
       </FONT>
      </B>
     </TD>
     <TD ALIGN="left">
      <FONT FACE="Arial,Helvetica,Geneva,Swiss,SunSans-Regular" COLOR="black">
       $arr[13]
      </FONT>
     </TD>
    </TR>

    <TR>
     <TD ALIGN="left">
      <B>
       <FONT FACE="Arial,Helvetica,Geneva,Swiss,SunSans-Regular" COLOR="black">
        Sexo:
       </FONT>
      </B>
     </TD>
     <TD ALIGN="left">
      <FONT FACE="Arial,Helvetica,Geneva,Swiss,SunSans-Regular" COLOR="black">
       $arr[2]
      </FONT>
     </TD>
    </TR>

    <TR>
     <TD ALIGN="left">
      <B>
       <FONT FACE="Arial,Helvetica,Geneva,Swiss,SunSans-Regular" COLOR="black">
        Documento:
       </FONT>
      </B>
     </TD>
     <TD ALIGN="left">
      <FONT FACE="Arial,Helvetica,Geneva,Swiss,SunSans-Regular" COLOR="black">
       $arr[3]
      </FONT>
     </TD>
    </TR>

    <TR>
     <TD ALIGN="left">
      <B>
       <FONT FACE="Arial,Helvetica,Geneva,Swiss,SunSans-Regular" COLOR="black">
        Contrase&ntilde;a:
       </FONT>
      </B>
     </TD>
     <TD ALIGN="left">
      <FONT FACE="Arial,Helvetica,Geneva,Swiss,SunSans-Regular" COLOR="black">
       $password
      </FONT>
     </TD>
    </TR>

    <TR>
     <TD ALIGN="left">
      <B>
       <FONT FACE="Arial,Helvetica,Geneva,Swiss,SunSans-Regular" COLOR="black">
        Direcci&oacute;n:
       </FONT>
      </B>
     </TD>
     <TD ALIGN="left">
      <FONT FACE="Arial,Helvetica,Geneva,Swiss,SunSans-Regular" COLOR="black">
       $arr[4]
      </FONT>
     </TD>
    </TR>

    <TR>
     <TD ALIGN="left">
      <B>
       <FONT FACE="Arial,Helvetica,Geneva,Swiss,SunSans-Regular" COLOR="black">
        Localidad:
       </FONT>
      </B>
     </TD>
     <TD ALIGN="left">
      <FONT FACE="Arial,Helvetica,Geneva,Swiss,SunSans-Regular" COLOR="black">
       $arr[5]
      </FONT>
     </TD>
    </TR>

    <TR>
     <TD ALIGN="left">
      <B>
       <FONT FACE="Arial,Helvetica,Geneva,Swiss,SunSans-Regular" COLOR="black">
        C&oacute;digo Postal:
       </FONT>
      </B>
     </TD>
     <TD ALIGN="left">
      <FONT FACE="Arial,Helvetica,Geneva,Swiss,SunSans-Regular" COLOR="black">
       $arr[6]
      </FONT>
     </TD>
    </TR>

    <TR>
     <TD ALIGN="left">
      <B>
       <FONT FACE="Arial,Helvetica,Geneva,Swiss,SunSans-Regular" COLOR="black">
        Tel&eacute;fono:
       </FONT>
      </B>
     </TD>
     <TD ALIGN="left">
      <FONT FACE="Arial,Helvetica,Geneva,Swiss,SunSans-Regular" COLOR="black">
       $arr[7]
      </FONT>
     </TD>
    </TR>

    <TR>
     <TD ALIGN="left">
      <B>
       <FONT FACE="Arial,Helvetica,Geneva,Swiss,SunSans-Regular" COLOR="black">
        IVA:
       </FONT>
      </B>
     </TD>
     <TD ALIGN="left">
      <FONT FACE="Arial,Helvetica,Geneva,Swiss,SunSans-Regular" COLOR="black">
       Tipo de IVA:
       &nbsp; &nbsp;
       $arr[8]
       &nbsp; &nbsp; &nbsp; &nbsp;
       Cuit:
       &nbsp; &nbsp;
       $arr[9]
      </FONT>
     </TD>
    </TR>

    <TR>
     <TD ALIGN="left">
      <B>
       <FONT FACE="Arial,Helvetica,Geneva,Swiss,SunSans-Regular" COLOR="black">
        Plan Contratado:
       </FONT>
      </B>
     </TD>
     <TD ALIGN="left">
      <FONT FACE="Arial,Helvetica,Geneva,Swiss,SunSans-Regular" COLOR="black">
       $arr[12]
      </FONT>
     </TD>
    </TR>

    <TR>
     <TD ALIGN="left">
      <B>
       <FONT FACE="Arial,Helvetica,Geneva,Swiss,SunSans-Regular" COLOR="black">
        Cuentas de E-mail:
       </FONT>
      </B>
     </TD>
     <TD ALIGN="left">
      <FONT FACE="Arial,Helvetica,Geneva,Swiss,SunSans-Regular" COLOR="black">
       $arr[11]
      </FONT>
     </TD>
    </TR>
body_baja

		if ($nivel eq "Acceso Total")
		{
			print <<body_baja;
    <TR>
     <TD ALIGN="left">
      <B>
       <FONT FACE="Arial,Helvetica,Geneva,Swiss,SunSans-Regular" COLOR="black">
        Grupo de Usuario:
       </FONT>
      </B>
     </TD>
     <TD ALIGN="left">
      <FONT FACE="Arial,Helvetica,Geneva,Swiss,SunSans-Regular" COLOR="black">
       $arr[14]
      </FONT>
     </TD>
    </TR>
body_baja
		}

		print <<body_baja;
    <TR>
     <TD ALIGN="left">
      <B>
       <FONT FACE="Arial,Helvetica,Geneva,Swiss,SunSans-Regular" COLOR="black">
        Agente de Ventas:
       </FONT>
      </B>
     </TD>
     <TD ALIGN="left">
      <FONT FACE="Arial,Helvetica,Geneva,Swiss,SunSans-Regular" COLOR="black">
       $arr[15]
      </FONT>
     </TD>
    </TR>

    <TR>
     <TD ALIGN="left">
      <B>
       <FONT FACE="Arial,Helvetica,Geneva,Swiss,SunSans-Regular" COLOR="black">
        Estado:
       </FONT>
      </B>
     </TD>
     <TD ALIGN="left">
      <FONT FACE="Arial,Helvetica,Geneva,Swiss,SunSans-Regular" COLOR="black">
       $arr[10]
      </FONT>
     </TD>
    </TR>

    <TR>
     <TD ALIGN="center" COLSPAN="2" CONTENT VALIGN="center">
      <B>
       <FONT FACE="Arial,Helvetica,Geneva,Swiss,SunSans-Regular" COLOR="black">
        <INPUT TYPE="submit" VALUE="Eliminar">
       </FONT>
      </B>
     </TD>
    </TR>

   </TABLE>
  </FORM>
body_baja
	}
	else
	{
		&return_error_mysql ("Error en el proceso", "Existen varios usuarios que responden a ese patr&oacute;n de eliminaci&oacute;n", $dbh->errmsg());
	}
}
else
{
	&return_error_mysql ("Error en el proceso", "No puede ingresar directamente a esta p&aacute;gina", "");
}
&tail_html("/radadm/index.html");
exit(0);
